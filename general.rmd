---
title: "General plots"
output: html_notebook
---

We will start by loading the data set:

```{r}
library(mbtools)
library(ggplot2)
theme_set(theme_classic())

ps <- readRDS("data/taxonomy.rds")
sdata <- read.csv("data/barcodes.csv", stringsAsFactors = FALSE)
rownames(sdata) <- sdata$isb_id
sdata$isb_id[sdata$isb_id == "T0RW"] <- "T0R"
sample_data(ps) <- sdata
sample_names(ps)[sample_names(ps) == "T0RW"] <- "T0R"
ps
```

Taxa plots

```{r}
plot_taxa(ps, level = "phylum")
```

## Ordination

```{r, fig.width=6, fig.height=4}
ord <- ordinate(rarefy_even_depth(ps, 3000), method="PCoA")
plot_ordination(ps, ord, color="compartment", shape="inoculum", label="isb_id") + 
  stat_ellipse(aes(group = compartment), type = "t") +
ggsave("figures/pcoa.svg", width = 6, height = 4)
```

And the corresponding PERMANOVA:

```{r}
library(vegan)

counts <- taxa_count(rarefy_even_depth(ps, 3000), NA)[reads >= 1] %>% as.matrix()
perm <- adonis(counts ~ compartment*inoculum, data = sdata)
perm
```

### Dynamics

```{r}
biofilters <- subset_samples(ps, compartment == "biofilter" | isb_id %in% c("T0B", "T0Comm"))
ord <- ordinate(rarefy_even_depth(biofilters), method="PCoA")
df <- plot_ordination(biofilters, ord, color = "inoculum", justDF = TRUE)

ggplot(df, aes(x=Axis.1, y=Axis.2, color=inoculum)) + geom_point(size=3, alpha=0.5) + 
  geom_line(aes(group=tank), data=function(x) dplyr::filter(x, compartment == "biofilter"), 
            arrow=arrow(ends = "first", type = "closed", length = unit(0.2, "cm"))) + 
  geom_text(aes(label=isb_id), nudge_y=-0.02, size=3) +
  theme_bw() + labs(x=sprintf("Axis.1 [%.1f%%]", ord$values[1, 2] * 100), y=sprintf("Axis.2 [%.1f%%]", ord$values[2, 2] * 100))
ggsave("figures/dynamics.pdf")
```
## Richness

```{r, fig.width=6, fig.height=4}
alpha <- cbind(
  estimate_richness(rarefy_even_depth(ps, 3000))[sample_names(ps), ], 
  sample_data(ps))

ggplot(alpha, aes(x = sample_set, y = Chao1, shape = inoculum, 
                        color = compartment, group = inoculum)) +        
        geom_point(position = position_dodge(width=0.5)) +
  labs(x = "time point", y = "Richness [Chao1 estimator]")
ggsave("figures/diversity.svg", width = 6, height = 3)
```

Corresponding tests:

```{r}
alpha <- as.data.table(alpha)
alpha[compartment == "biofilter" & sample_set == "T1", t.test(Chao1 ~ inoculum)]
```

## Heatmaps

```{r, fig.height=10, fig.width=8}
library(pheatmap)

counts <- as.matrix(taxa_count(ps)[reads >= 1]) %>% mbtools::normalize()
counts <- counts[, apply(counts, 2, function(x) max(x) > 300)]
counts <- counts[, !grepl("uncultured", colnames(counts))]
labels <- sdata[, c("compartment", "sample_set", "inoculum")]
names(labels)[2] <- "time point"

cols <- viridis::viridis(128) 
pheatmap(log10(t(counts) + 1), color = cols, annotation_col = labels,
         width = 8, height = 8, filename = "figures/heatmap.pdf")
pheatmap(log10(t(counts) + 1), color = cols, annotation_col = labels)
```

Most abundant:

```{r}
sort(apply(counts, 2, sum), decreasing = TRUE)[1:10]
```

Heatmap for Nitrifiers:

```{r, fig.height=2.1, fig.width=8}
library(pheatmap)

counts <- as.matrix(taxa_count(ps, zeros = TRUE)[grepl("Nitro", taxa)])
pheatmap(log10(t(counts) + 1))
```

As percentages:

```{r, fig.height=3, fig.width=8}
all_counts <- as.matrix(taxa_count(ps, zeros = TRUE))
pheatmap(t(counts / rowSums(all_counts)) * 100)
```