---
title: "Greenhouse data"
output: html_notebook
---

## Greenhouse data for tanks

```{r}
library(data.table)
library(ggplot2)
theme_set(theme_classic())

greenhouse <- fread("data/greenhouse.csv")
greenhouse[, date := as.Date(date, format = "%m/%d/%y")]
greenhouse[, time := difftime(date, date[1], units = "days")]
greenhouse[, inoculum := "aquaponics system"]
greenhouse[tank %in% 1:3, inoculum := "commercial"]
greenhouse[, tank := factor(tank)]
greenhouse <- greenhouse[order(time, tank)]
indicators <- greenhouse[, .(time, tank, inoculum, chlorine, alkalinity, pH, `conductivity (uS/cm)`, 
                             hardness, `total fish food`, `water added (L)`, greenhouse_temp, 
                             greenhouse_humidity)]
indicators <- melt(indicators, id.vars=c("time", "tank", "inoculum"), variable.name="measure")
indicators[, value := as.numeric(value)]

sampling_dates <- difftime(as.Date(c("2017-06-28", "2017-07-19", "2017-08-28")),
                           greenhouse$date[1], units = "days")
```

Plot indicators across time

```{r, fig.width=8, fig.height=6}
ggplot(indicators[!is.na(value)], aes(x=time, y=value, color=tank, group=tank)) + 
  geom_point() + geom_line() + facet_wrap(~ measure, scales = "free_y")
ggsave("figures/indicators_time.pdf", width=8, height=6)
```


As boxplots

```{r, fig.width=6, fig.height=5}
ggplot(indicators, aes(x=tank, y=value, color=tank)) + 
  geom_boxplot() + facet_wrap(~ measure, scales="free_y") + 
  guides(color=FALSE)
ggsave("figures/indicators.pdf", width=6, height=5)
```

```{r}
nitrogen <- melt(greenhouse[, .(time, tank, inoculum, nitrate, nitrite, ammonia)],
                 id.vars=c("time", "tank", "inoculum"), variable.name="measure")
nitrogen[, value := as.numeric(value)]
```

```{r, fig.width=8, fig.height=3}
nitrogen[, measure := factor(measure, levels=c("ammonia", "nitrite", "nitrate"))]
ggplot(nitrogen, aes(x=time, y=value, color=measure)) + 
  geom_point() + stat_smooth(aes(fill = measure)) + facet_wrap(~ measure, scales="free_y") +
  geom_vline(xintercept=sampling_dates, lty="dashed") + theme_minimal() +
  guides(color = FALSE, fill = FALSE) + 
    labs(x = "time [days]", y = "concentration [ppm]")
ggsave("figures/nitrogen_time.svg", width = 8, height = 3)
```

Relationship with plant growth:

We will plot the area under the curve vs the plant measure.

```{r}
library(phyloseq)

trapz <- function(x, y) {
  y[is.na(y)] <- 0
  sum((y[2:length(y)] + y[1:(length(y) - 1)]) * as.numeric(diff(x))) * 0.5
}

aucs <- nitrogen[, .(auc = trapz(time, value), inoculum = inoculum[1]), by=c("measure", "tank")]
plants <- as(sample_data(readRDS("data/taxonomy.rds")), "data.frame")
setDT(plants)
plants[, tank := factor(tank)]
plants <- melt(plants[sample_set == "T2" & environment == "bioball"], 
               id.vars="tank", measure.vars = c("no_leaves", "root_length", "height"), 
               variable.name = "plant_measure")

aucs <- aucs[plants, on="tank", allow.cartesian = T]

ggplot(aucs, aes(x=value, y=auc, color=inoculum)) + geom_point() + 
  facet_grid(measure ~ plant_measure, scales="free") + theme_light()
ggsave("data/aucs_nitrogen.pdf")
```